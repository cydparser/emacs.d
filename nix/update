#! /usr/bin/env nix-shell
#! nix-shell --pure -i bash -p cabal2nix curl nix nix-prefetch-github
# Local Variables:
# mode: sh
# End:
set -e

cd "$(dirname "$0")"/..

if [[ "$#" -gt 0 ]]; then
  packages=( "$@" )
else
  packages=( dhall hies jdt-language-server nix-linter )
fi

for p in "${packages[@]}"; do
  case "$p" in
    codex)
      nix-prefetch-github aloiscochard codex > nix/codex.json ;;
    dhall)
      cabal2nix cabal://dhall > nix/dhall.nix ;;
    haskell-src-exts)
      cabal2nix cabal://haskell-src-exts > nix/haskell-src-exts.nix ;;
    hasktags)
      cabal2nix cabal://hasktags > nix/hasktags.nix ;;
    hies)
      nix-prefetch-github domenkozar hie-nix > nix/hie-nix.json ;;
    hlint)
      cabal2nix cabal://hlint > nix/hlint.nix ;;
    jdt-language-server)
      _url="https://download.eclipse.org/jdtls/snapshots/$(curl --fail https://download.eclipse.org/jdtls/snapshots/latest.txt)"
      _sha="$(nix-prefetch-url "$_url")"
      echo "{ \"url\": \"$_url\", \"sha256\": \"$_sha\" }" > nix/jdt-language-server.json
      ;;
    nix-linter)
      nix-prefetch-github Synthetica9 nix-linter > nix/nix-linter.json ;;
    repline)
      cabal2nix cabal://repline > nix/repline.nix ;;
    *)
      echo "ERROR: Unknown package: $p" >&2
      exit 1
  esac
done
